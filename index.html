<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>LogGoblin</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; }
    input { margin: 5px; }

    #log {
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .log-entry {
      border: 1px solid #3b2425;
      border-radius: 2px;
      padding: 8px 12px;
      background: #372020;
      box-shadow: 0 1px 3px rgba(111, 104, 104, 0.1);
    }

    .log-meta {
      font-size: 0.85em;
      margin-bottom: 4px;
      display: flex;
      gap: 8px;
      color: #555;
    }

    .retained {
      background-color: darkslategrey;
    }

    .log-timestamp {
      color: #7490a4;
      font-weight: bold;
    }

    .log-host {
      color: #e2e866;
    }

    .log-file {
      color: #e4a15d;
      font-style: italic;
    }

    .log-message {
      font-family: monospace;
      white-space: pre-wrap; /* bevarer linebreaks */
      color: #f0f0f0;
    }

    h1 {
      font-family: monospace;
      font-size: 30px;
    }
  </style>
</head>
<body>
  <h1><img src="LogGoblin.png" width="40" height="40" style="padding-right:8px" />LogGoblin</h1>

  <div id="config">
    <label>Bucket ID:</label>
    <input type="text" id="bucketID" placeholder="Enter JSONbin bucket ID">
    <br>
    <label>Access Key:</label>
    <input type="password" id="accessKey" placeholder="Enter JSONbin Access Key">
    <br>
    <button onclick="saveConfig()">Save Config</button>
    <button onclick="clearConfig()">Clear Config</button>
    <a href="javascript:void(loadLogs())">Reload</a>
  </div>

  <hr>

  <div id="log">Loading logs...</div>

  <script>
    function saveConfig() {
      localStorage.setItem("bucketID", document.getElementById("bucketID").value);
      localStorage.setItem("accessKey", document.getElementById("accessKey").value);
      loadLogs();
    }

    function clearConfig() {
      localStorage.removeItem("bucketID");
      localStorage.removeItem("accessKey");
      document.getElementById("log").textContent = "Configuration cleared.";
    }

    let lastTimestamp = null;

    async function loadLogs() {
      const bucketID = localStorage.getItem("bucketID");
      const accessKey = localStorage.getItem("accessKey");

      if (!bucketID || !accessKey) {
        document.getElementById("log").textContent = "Please enter and save Bucket ID and Access Key.";
        return;
      }

      document.getElementById("config").style.display = 'none';

      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${bucketID}/latest`, {
          headers: {
            "X-Access-Key": accessKey
          }
        });

        if (!res.ok) {
          throw new Error("Request failed: " + res.status);
        }

        const data = await res.json();
        const logs = data.record;

        if (!logs || logs.length === 0) {
          document.getElementById("log").textContent = "No logs found.";
          return;
        }

        const newest = logs[logs.length - 1]; // siste logg
        if (!lastTimestamp || newest.timestamp !== lastTimestamp) {
          // Ny melding!
          showNotification(newest);
          lastTimestamp = newest.timestamp;
        }

        // Nyeste først
        const reversed = logs.slice().reverse();

        const container = document.getElementById("log");
        container.innerHTML = ""; // tøm gammel output

        const retained = JSON.parse(localStorage.getItem("retainedLogs") || "[]");

        retained.forEach(r => {
          reversed.push(r);
        });
        

        reversed.forEach(l => {
          const logDiv = document.createElement("div");
          const id = `${l.timestamp}-${l.hostname}-${l.filename}`;
          const isRetained = retained.some((r) => r.id === id);

          logDiv.className = `log-entry ${isRetained ? "retained" : ""}`;

          logDiv.innerHTML = `
            <div class="log-meta">
              <span class="log-timestamp">[${l.timestamp}]</span>
              <span class="log-host">${l.hostname}</span>
              <span class="log-file">${l.filename}</span>
              <button class="retain-btn">${isRetained ? "Unretain" : "Retain"}</button>
            </div>
            <div class="log-message">${l.message}</div>
          `;

          const btn = logDiv.querySelector(".retain-btn");
          btn.addEventListener("click", () => {
            const retainedNow = JSON.parse(localStorage.getItem("retainedLogs") || "[]");

            if (isRetained) {
              // remove
              const updated = retainedNow.filter((r) => r.id !== id);
              localStorage.setItem("retainedLogs", JSON.stringify(updated));
              btn.textContent = "Retain";
            } else {
              // add
              retainedNow.push({ id, ...l });
              localStorage.setItem("retainedLogs", JSON.stringify(retainedNow));
              btn.textContent = "Unretain";
            }
          });

          container.appendChild(logDiv);
        });

      } catch (e) {
        document.getElementById("log").innerHTML = "<p>Error fetching logs: " + e.message + "</p>";
      }
    }

    // Initial load + refresh hvert 15. sekund
    loadLogs();
    setInterval(loadLogs, 120 * 1000);

    function showNotification(log) {
      if (Notification.permission === "granted") {
        new Notification("Ny loggmelding", {
          body: `[${log.hostname}] ${log.message}`,
          icon: "bell.png" // valgfritt ikon
        });
      }
    }

    async function requestNotificationPermission() {
      if (!("Notification" in window)) {
        alert("Denne nettleseren støtter ikke varslinger");
        return;
      }
      const permission = await Notification.requestPermission();
      if (permission !== "granted") {
        alert("Varslinger ble ikke tillatt");
      }
      else {
        document.getElementById("allowNotif").style.display = 'none';
      }
    }
  </script>
  <button id="allowNotif" onclick="requestNotificationPermission()">Tillat varsler</button>
</body>
</html>